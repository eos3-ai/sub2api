# =============================================================================
# Sub2API Docker Environment Configuration
# =============================================================================
# Copy this file to .env and modify as needed:
#   cp .env.example .env
#   nano .env
#
# Then start with: docker-compose up -d
# =============================================================================

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
# Bind address for host port mapping
BIND_HOST=0.0.0.0

# Server port (exposed on host)
SERVER_PORT=8080

# Server mode: release or debug
SERVER_MODE=release

# 运行模式: standard (默认) 或 simple (内部自用)
# standard: 完整 SaaS 功能，包含计费/余额校验；simple: 隐藏 SaaS 功能并跳过计费/余额校验
RUN_MODE=standard

# Timezone
TZ=Asia/Shanghai

# -----------------------------------------------------------------------------
# PostgreSQL Configuration (REQUIRED)
# -----------------------------------------------------------------------------
POSTGRES_USER=sub2api
POSTGRES_PASSWORD=change_this_secure_password
POSTGRES_DB=sub2api

# -----------------------------------------------------------------------------
# Redis Configuration
# -----------------------------------------------------------------------------
# Leave empty for no password (default for local development)
REDIS_PASSWORD=
REDIS_DB=0

# -----------------------------------------------------------------------------
# Admin Account
# -----------------------------------------------------------------------------
# Email for the admin account
ADMIN_EMAIL=admin@sub2api.local

# Password for admin account
# Leave empty to auto-generate (will be shown in logs on first run)
ADMIN_PASSWORD=

# -----------------------------------------------------------------------------
# JWT Configuration
# -----------------------------------------------------------------------------
# Leave empty to auto-generate (recommended)
JWT_SECRET=
JWT_EXPIRE_HOUR=24

# -----------------------------------------------------------------------------
# Configuration File (Optional)
# -----------------------------------------------------------------------------
# Path to custom config file (relative to docker-compose.yml directory)
# Copy config.example.yaml to config.yaml and modify as needed
# Leave unset to use default ./config.yaml
#CONFIG_FILE=./config.yaml

# -----------------------------------------------------------------------------
# Security Configuration
# -----------------------------------------------------------------------------
# URL Allowlist Configuration
# 启用 URL 白名单验证（false 则跳过白名单检查，仅做基本格式校验）
SECURITY_URL_ALLOWLIST_ENABLED=false

# 关闭白名单时，是否允许 http:// URL（默认 false，只允许 https://）
# ⚠️ 警告：允许 HTTP 存在安全风险（明文传输），仅建议在开发/测试环境或可信内网中使用
# Allow insecure HTTP URLs when allowlist is disabled (default: false, requires https)
# ⚠️ WARNING: Allowing HTTP has security risks (plaintext transmission)
#             Only recommended for dev/test environments or trusted networks
SECURITY_URL_ALLOWLIST_ALLOW_INSECURE_HTTP=true

# 是否允许本地/私有 IP 地址用于上游/定价/CRS（仅在可信网络中使用）
# Allow localhost/private IPs for upstream/pricing/CRS (use only in trusted networks)
SECURITY_URL_ALLOWLIST_ALLOW_PRIVATE_HOSTS=true

# -----------------------------------------------------------------------------
# Gemini OAuth (OPTIONAL, required only for Gemini OAuth accounts)
# -----------------------------------------------------------------------------
# Sub2API supports TWO Gemini OAuth modes:
#
# 1. Code Assist OAuth (需要 GCP project_id)
#    - Uses: cloudcode-pa.googleapis.com (Code Assist API)
#    - Auto scopes: cloud-platform + userinfo.email + userinfo.profile
#    - OAuth Client: Can use built-in Gemini CLI client (留空即可)
#    - Requires: Google Cloud Platform project with Code Assist enabled
#
# 2. AI Studio OAuth (不需要 project_id)
#    - Uses: generativelanguage.googleapis.com (AI Studio API)
#    - Default scopes: generative-language
#    - OAuth Client: Requires your own OAuth 2.0 Client (内置 Gemini CLI client 不能申请 generative-language scope)
#    - Requires: Create OAuth 2.0 Client in GCP Console + OAuth consent screen
#    - Setup Guide: https://ai.google.dev/gemini-api/docs/oauth
#    - ⚠️ IMPORTANT: OAuth Client 必须发布为正式版本 (Production)
#      Testing 模式限制: 只能添加 100 个测试用户, refresh token 7 天后过期
#      发布步骤: GCP Console → OAuth consent screen → PUBLISH APP
#
# Configuration:
# Leave empty to use the built-in Gemini CLI OAuth client (Code Assist OAuth only).
# To enable AI Studio OAuth, set your own OAuth client ID/secret here.
GEMINI_OAUTH_CLIENT_ID=
GEMINI_OAUTH_CLIENT_SECRET=
# Optional; leave empty to auto-select scopes based on oauth_type
GEMINI_OAUTH_SCOPES=

# -----------------------------------------------------------------------------
# Gemini Quota Policy (OPTIONAL, local simulation)
# -----------------------------------------------------------------------------
# JSON overrides for local quota simulation (Code Assist only).
# Example:
# GEMINI_QUOTA_POLICY={"tiers":{"LEGACY":{"pro_rpd":50,"flash_rpd":1500,"cooldown_minutes":30},"PRO":{"pro_rpd":1500,"flash_rpd":4000,"cooldown_minutes":5},"ULTRA":{"pro_rpd":2000,"flash_rpd":0,"cooldown_minutes":5}}}
GEMINI_QUOTA_POLICY=

# -----------------------------------------------------------------------------
# Payment / Recharge (OPTIONAL)
# -----------------------------------------------------------------------------
# Enables the new frontend pages:
#   - /payment (recharge plans + "my orders" as recharge records)
#
# Notes:
# - When PAYMENT_ENABLED=false, you can still view plans, but creating orders will fail.
# - Frontend pay methods are "Alipay / WeChat":
#   - Alipay => provider ZPay
#   - WeChat => provider Stripe
# - When providers are enabled and configured correctly, creating an order will return `pay_url` (and sometimes `qr_url`).
#   The frontend will render QR code from `pay_url` and poll order status until paid/expired/failed.
# - PAYMENT_PACKAGES is optional; if omitted, the app uses built-in defaults from config.go.
#
# Enable payment module
PAYMENT_ENABLED=false

# Pricing and order settings
# Public base URL used to resolve relative notify/return URLs (required if you keep notify/return as relative paths)
PAYMENT_BASE_URL=
PAYMENT_MIN_AMOUNT=1.0
PAYMENT_MAX_AMOUNT=10000.0
PAYMENT_EXCHANGE_RATE=7.2
# Discount rate in (0,1], e.g. 0.15 means "pay 15%"
PAYMENT_DISCOUNT_RATE=0.15
PAYMENT_ORDER_EXPIRE_MINUTES=30
PAYMENT_MAX_ORDERS_PER_MINUTE=3
PAYMENT_ORDER_PREFIX=ORD_

# Recharge plans (JSON array)
# Note: UI displays `label` directly; recommended to keep it in USD (e.g. "$100")
# Example (exchange_rate=7.2, discount_rate=0.15 => pay 15%):
# PAYMENT_PACKAGES='[{"amount_usd":100,"label":"$100","popular":false},{"amount_usd":200,"label":"$200","popular":false},{"amount_usd":500,"label":"$500","popular":true},{"amount_usd":1000,"label":"$1000","popular":false}]'
PAYMENT_PACKAGES=

# ZPay (WIP)
# NOTE:
# - This repo reads env vars via Viper with '.' -> '_' mapping, so the prefix is `PAYMENT_`.
# - This repo ALSO supports legacy env var names (without `PAYMENT_`), such as `ZPAY_ENABLED` / `STRIPE_SECRET_KEY`.
#   Prefer the `PAYMENT_` prefixed variables for new deployments.
PAYMENT_ZPAY_ENABLED=false
PAYMENT_ZPAY_PID=
PAYMENT_ZPAY_KEY=
PAYMENT_ZPAY_API_URL=https://zpayz.cn
PAYMENT_ZPAY_SUBMIT_URL=https://zpayz.cn/submit.php
PAYMENT_ZPAY_QUERY_URL=https://zpayz.cn/api.php
PAYMENT_ZPAY_PAYMENT_METHODS=alipay,wxpay
# You can use either `/api/payment/webhook/zpay` or `/payment/zpay/notify` (both are routed to the same handler)
PAYMENT_ZPAY_NOTIFY_URL=/api/payment/webhook/zpay
PAYMENT_ZPAY_RETURN_URL=/payment/result
PAYMENT_ZPAY_NOTIFY_USER=false
PAYMENT_ZPAY_IP_WHITELIST=
PAYMENT_ZPAY_REQUIRE_HTTPS=true

# Stripe (WIP)
PAYMENT_STRIPE_ENABLED=false
PAYMENT_STRIPE_API_KEY=
PAYMENT_STRIPE_WEBHOOK_SECRET=
PAYMENT_STRIPE_API_VERSION=
PAYMENT_STRIPE_PAYMENT_METHODS=wechat_pay
PAYMENT_STRIPE_CURRENCY=CNY
PAYMENT_STRIPE_SUCCESS_URL=/payment/return/stripe?order={ORDER_ID}&status=success
PAYMENT_STRIPE_CANCEL_URL=/payment/return/stripe?order={ORDER_ID}&status=cancel
PAYMENT_STRIPE_WECHAT_CLIENT=web
PAYMENT_STRIPE_WECHAT_APP_ID=

# -----------------------------------------------------------------------------
# Promotion (First Recharge Bonus) (OPTIONAL)
# -----------------------------------------------------------------------------
# New user first recharge bonus (only once).
#
# Notes:
# - The promotion window is based on user registration time.
# - PROMOTION_TIERS is optional; if omitted, the app uses built-in defaults from config.go.
PROMOTION_ENABLED=false
PROMOTION_DURATION_HOURS=72
PROMOTION_MIN_AMOUNT=0.0

# Promotion tiers (JSON array)
# Example:
# PROMOTION_TIERS='[{"hours":24,"bonus_percent":30},{"hours":36,"bonus_percent":20},{"hours":48,"bonus_percent":10},{"hours":72,"bonus_percent":5}]'
PROMOTION_TIERS=

# -----------------------------------------------------------------------------
# Referral Program (Invite & Reward) (OPTIONAL)
# -----------------------------------------------------------------------------
# Enables the `/referral` page and invite rewards.
REFERRAL_ENABLED=false

# Optional: prefer this base URL for invite links (e.g. "https://your-domain.com").
# If empty, backend falls back to PAYMENT_BASE_URL.
REFERRAL_BASE_URL=

# The frontend register route. Backend will convert to absolute URL if REFERRAL_BASE_URL (or PAYMENT_BASE_URL) is set.
REFERRAL_LINK_BASE_URL=/register

# Reward credits (USD) for the inviter, issued when invitee reaches the qualified amount.
REFERRAL_REWARD_USD=10

# Invitee qualified threshold. If both are set, REFERRAL_QUALIFIED_RECHARGE_USD takes precedence.
REFERRAL_QUALIFIED_RECHARGE_CNY=20
REFERRAL_QUALIFIED_RECHARGE_USD=0

# Code settings
REFERRAL_CODE_LENGTH=8
REFERRAL_MAX_INVITEES_PER_USER=0
