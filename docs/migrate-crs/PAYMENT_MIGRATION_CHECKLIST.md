# æ”¯ä»˜ç³»ç»Ÿè¿ç§»å®Œæ•´è§„åˆ’æ–‡æ¡£

åŸºäº `docs/crs/INTEGRATION_GUIDE.md` æ–‡æ¡£ï¼Œå°†æ”¯ä»˜ã€æ´»åŠ¨ä¼˜æƒ ã€é‚€è¯·è¿”åˆ©ç­‰åŠŸèƒ½æ•´åˆåˆ°å½“å‰ Go é¡¹ç›®ä¸­ã€‚

---

## ç›®å½•

1. [é¡¹ç›®ç°çŠ¶åˆ†æ](#ä¸€é¡¹ç›®ç°çŠ¶åˆ†æ)
2. [è¿ç§»èŒƒå›´ä¸ç­–ç•¥](#äºŒè¿ç§»èŒƒå›´ä¸ç­–ç•¥)
3. [æ•°æ®åº“è®¾è®¡](#ä¸‰æ•°æ®åº“è®¾è®¡)
4. [è¡¨å…³è”å…³ç³»å›¾](#å››è¡¨å…³è”å…³ç³»å›¾)
5. [å„å±‚å®ç°æ¸…å•](#äº”å„å±‚å®ç°æ¸…å•)
6. [é…ç½®æ‰©å±•](#å…­é…ç½®æ‰©å±•)
7. [ä¸šåŠ¡æµç¨‹é›†æˆ](#ä¸ƒä¸šåŠ¡æµç¨‹é›†æˆ)
8. [å‰ç«¯å¼€å‘æ¸…å•](#å…«å‰ç«¯å¼€å‘æ¸…å•)
9. [æ‰§è¡Œé¡ºåºä¸è¿›åº¦](#ä¹æ‰§è¡Œé¡ºåºä¸è¿›åº¦)

---

## ä¸€ã€é¡¹ç›®ç°çŠ¶åˆ†æ

### 1.1 æŠ€æœ¯æ ˆå¯¹æ¯”

| æ–¹é¢ | åŸæ–‡æ¡£ (Node.js) | å½“å‰é¡¹ç›® (Go) |
|------|-----------------|--------------|
| è¯­è¨€ | JavaScript/Node.js | Go 1.24 |
| Webæ¡†æ¶ | Express | Gin |
| æ•°æ®å­˜å‚¨ | Redis (ä¸»å­˜å‚¨) | PostgreSQL (ä¸») + Redis (ç¼“å­˜) |
| ORM | æ—  (ç›´æ¥æ“ä½œ Redis) | GORM |
| æ¶æ„ | å•å±‚æœåŠ¡æ–‡ä»¶ | åˆ†å±‚æ¶æ„ (Handler â†’ Service â†’ Repository â†’ Model) |
| ä¾èµ–æ³¨å…¥ | æ‰‹åŠ¨ require | Google Wire |
| å¯†ç å“ˆå¸Œ | bcrypt (npm) | bcrypt (å·²é›†æˆ) |

### 1.2 ç°æœ‰æ•°æ®åº“è¡¨ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç°æœ‰è¡¨ç»“æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  (ç”¨æˆ·è¡¨)            â”‚                  â”‚                  â”‚                â”‚
â”‚  - id               â”‚                  â”‚                  â”‚                â”‚
â”‚  - email            â”‚                  â”‚                  â”‚                â”‚
â”‚  - password_hash    â”‚                  â”‚                  â”‚                â”‚
â”‚  - role             â”‚                  â”‚                  â”‚                â”‚
â”‚  - balance â†â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ å·²æœ‰ä½™é¢å­—æ®µ    â”‚                  â”‚                â”‚
â”‚  - concurrency      â”‚                  â”‚                  â”‚                â”‚
â”‚  - status           â”‚                  â”‚                  â”‚                â”‚
â”‚  - allowed_groups   â”‚                  â”‚                  â”‚                â”‚
â”‚         â”‚           â”‚                  â”‚                  â”‚                â”‚
â”‚         â–¼           â–¼                  â–¼                  â–¼                â”‚
â”‚    api_keys    redeem_codes    user_subscriptions    usage_logs           â”‚
â”‚    (APIå¯†é’¥)    (å…‘æ¢ç )         (ç”¨æˆ·è®¢é˜…)           (ä½¿ç”¨è®°å½•)            â”‚
â”‚                                                                             â”‚
â”‚  groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ account_groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ accounts                  â”‚
â”‚  (åˆ†ç»„)               (å…³è”è¡¨)                    (ä¸Šæ¸¸è´¦å·)                â”‚
â”‚                                                                             â”‚
â”‚  proxies                                                                    â”‚
â”‚  (ä»£ç†)                                                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç°æœ‰åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½æ¨¡å— | åŸæ–‡æ¡£ | å½“å‰é¡¹ç›® | è¿ç§»ç­–ç•¥ |
|---------|--------|---------|---------|
| ğŸ“§ é‚®ä»¶æœåŠ¡ | `emailService.js` | âœ… `email_service.go` | æ— éœ€è¿ç§» |
| ğŸ” ç”¨æˆ·è®¤è¯ | `userService.js` è®¤è¯éƒ¨åˆ† | âœ… `auth_service.go` | æ— éœ€è¿ç§» |
| ğŸ’µ ç”¨æˆ·ä½™é¢å­—æ®µ | `user.balance` | âœ… `users.balance` | æ— éœ€è¿ç§» |
| ğŸ’µ ä½™é¢å¢å‡ | `rechargeBalance/deductBalance` | âœ… `UpdateBalance/DeductBalance` | éœ€å°è£…+è®°å½•æµæ°´ |
| ğŸ’µ å……å€¼è®°å½• | Redis List å­˜å‚¨ | âŒ ä¸å­˜åœ¨ | æ–°å¢è¡¨å’ŒæœåŠ¡ |
| ğŸ æ´»åŠ¨ä¼˜æƒ  | `promotionService.js` | âŒ ä¸å­˜åœ¨ | å…¨æ–°å¼€å‘ |
| ğŸ‘¥ é‚€è¯·è¿”åˆ© | `referralService.js` | âŒ ä¸å­˜åœ¨ | å…¨æ–°å¼€å‘ |
| ğŸ’° æ”¯ä»˜ç³»ç»Ÿ | `paymentService.js` | âŒ ä¸å­˜åœ¨ | å…¨æ–°å¼€å‘ |
| ğŸ« å…‘æ¢ç  | - | âœ… `redeem_service.go` | æ— éœ€è¿ç§» |

### 1.4 UserService è¿ç§»è¯´æ˜

**ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿ç§» UserServiceï¼Ÿ**

åŸæ–‡æ¡£çš„ `userService.js` æ˜¯ä¸€ä¸ªå¤§å‹æœåŠ¡æ–‡ä»¶ï¼ŒåŒ…å«å¤šä¸ªåŠŸèƒ½åŸŸï¼š

```
åŸ userService.js
â”œâ”€â”€ ç”¨æˆ·è®¤è¯ (register, authenticate, password)  â†’ å½“å‰å·²æœ‰ auth_service.go
â”œâ”€â”€ ä½™é¢ç®¡ç† (recharge, deduct, getBalance)      â†’ å½“å‰å·²æœ‰ user_repo.go éƒ¨åˆ†æ–¹æ³•
â”œâ”€â”€ å……å€¼è®°å½• (getRechargeRecords)                â†’ éœ€è¦æ–°å¢
â””â”€â”€ ç”¨æˆ·æ•°æ® (CRUD)                              â†’ å½“å‰å·²æœ‰ user_service.go
```

**è¿ç§»ç­–ç•¥ï¼š**

1. **ä¿ç•™ç°æœ‰æœåŠ¡** - ä¸ä¿®æ”¹ `user_service.go` å’Œ `auth_service.go`
2. **æ–°å¢ BalanceService** - å°è£…ä½™é¢æ“ä½œï¼Œæ·»åŠ è®°å½•æµæ°´åŠŸèƒ½
3. **æ‰©å±• users è¡¨** - æ·»åŠ é‚€è¯·è¿”åˆ©ç›¸å…³å­—æ®µï¼ˆå¯é€‰ï¼‰

---

## äºŒã€è¿ç§»èŒƒå›´ä¸ç­–ç•¥

### 2.1 ç¡®è®¤çš„è¿ç§»èŒƒå›´

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| ğŸ’° æ”¯ä»˜ç³»ç»Ÿ | âœ… éœ€è¦ | Zpay + Stripe åŒæ—¶å®ç° |
| ğŸ æ´»åŠ¨ä¼˜æƒ  | âœ… éœ€è¦ | æ–°ç”¨æˆ·é™æ—¶å……å€¼èµ é€ |
| ğŸ‘¥ é‚€è¯·è¿”åˆ© | âœ… éœ€è¦ | é‚€è¯·ç  + è¿”åˆ©å‘æ”¾ |
| ğŸ’µ å……å€¼è®°å½• | âœ… éœ€è¦ | å®Œæ•´ä½™é¢å˜åŠ¨æµæ°´ |

### 2.2 æœåŠ¡å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æœåŠ¡å±‚æ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ç°æœ‰æœåŠ¡ (ä¿ç•™ä¸åŠ¨)                æ–°å¢æœåŠ¡                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ auth_service    â”‚              â”‚ balance_service â”‚ â† å°è£…ä½™é¢+è®°å½•æµæ°´    â”‚
â”‚  â”‚ user_service    â”‚              â”‚ promotion_svc   â”‚ â† æ´»åŠ¨ä¼˜æƒ             â”‚
â”‚  â”‚ redeem_service  â”‚              â”‚ referral_svc    â”‚ â† é‚€è¯·è¿”åˆ©            â”‚
â”‚  â”‚ billing_service â”‚              â”‚ payment_service â”‚ â† æ”¯ä»˜æ ¸å¿ƒ            â”‚
â”‚  â”‚ ...             â”‚              â”‚ zpay_service    â”‚ â† Zpay æ¸ é“           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ stripe_service  â”‚ â† Stripe æ¸ é“         â”‚
â”‚           â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚                                â”‚                                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â–¼                                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚              â”‚  user_repo.go   â”‚ â† ç°æœ‰ï¼Œæä¾› UpdateBalance ç­‰æ–¹æ³•          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ–°å¢è¡¨æ¦‚è§ˆ

| è¡¨å | è¯´æ˜ | ä¸»è¦å…³è” |
|------|------|---------|
| `recharge_records` | å……å€¼/æ‰£æ¬¾æµæ°´è®°å½• | users |
| `user_promotions` | ç”¨æˆ·æ´»åŠ¨èµ„æ ¼çŠ¶æ€ | users |
| `promotion_records` | æ´»åŠ¨ä½¿ç”¨å†å² | users |
| `referral_codes` | ç”¨æˆ·é‚€è¯·ç  | users |
| `referral_invites` | é‚€è¯·å…³ç³»è®°å½• | users (åŒå‘) |
| `payment_orders` | æ”¯ä»˜è®¢å• | users |

### 3.2 users è¡¨æ‰©å±•ï¼ˆå¯é€‰ï¼‰

```sql
-- å¯é€‰ï¼šä¸ºé‚€è¯·è¿”åˆ©æ·»åŠ å­—æ®µï¼ˆä¹Ÿå¯ä»¥é€šè¿‡ referral_invites æŸ¥è¯¢è®¡ç®—ï¼‰
ALTER TABLE users ADD COLUMN IF NOT EXISTS referrer_id BIGINT REFERENCES users(id);
ALTER TABLE users ADD COLUMN IF NOT EXISTS total_recharge DECIMAL(20,8) DEFAULT 0;
```

**è®¾è®¡å†³ç­–ï¼š** å»ºè®®ä¸ä¿®æ”¹ users è¡¨ï¼Œé€šè¿‡å…³è”è¡¨æŸ¥è¯¢å®ç°ï¼Œä¿æŒè¡¨çš„å•ä¸€èŒè´£ã€‚

### 3.3 recharge_records è¡¨ï¼ˆå……å€¼è®°å½•ï¼‰

**ç”¨é€”ï¼š** è®°å½•æ‰€æœ‰ä½™é¢å˜åŠ¨çš„æµæ°´ï¼Œæ”¯æŒå®¡è®¡å’Œå¯¹è´¦ã€‚

```sql
CREATE TABLE recharge_records (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- å˜åŠ¨ä¿¡æ¯
    amount          DECIMAL(20, 8) NOT NULL,    -- å˜åŠ¨é‡‘é¢ï¼Œæ­£=å……å€¼ï¼Œè´Ÿ=æ‰£æ¬¾
    type            VARCHAR(20) NOT NULL,       -- ç±»å‹
    operator        VARCHAR(100),               -- æ“ä½œè€…
    remark          VARCHAR(500),               -- å¤‡æ³¨
    related_id      VARCHAR(100),               -- å…³è”ID

    -- ä½™é¢å¿«ç…§ï¼ˆç”¨äºå¯¹è´¦ï¼‰
    balance_before  DECIMAL(20, 8) NOT NULL,
    balance_after   DECIMAL(20, 8) NOT NULL,

    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| `amount` | DECIMAL | æ­£æ•°=å……å€¼ï¼Œè´Ÿæ•°=æ‰£æ¬¾ | 10.00, -5.50 |
| `type` | VARCHAR | å˜åŠ¨ç±»å‹ | admin, payment, redeem, referral, deduct, refund |
| `operator` | VARCHAR | æ“ä½œè€…æ ‡è¯† | admin@example.com, system |
| `related_id` | VARCHAR | å…³è”ä¸šåŠ¡ID | è®¢å•å·ã€å…‘æ¢ç  |
| `balance_before/after` | DECIMAL | å˜åŠ¨å‰åä½™é¢å¿«ç…§ | ç”¨äºå®¡è®¡å’Œå¯¹è´¦ |

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• |
|---------|---------|------|
| ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è®°å½• | `WHERE user_id = ? ORDER BY created_at DESC` | `idx_user_created` (è¦†ç›–) |
| ç®¡ç†å‘˜æŒ‰ç±»å‹ç­›é€‰ | `WHERE type = ? ORDER BY created_at DESC` | `idx_type_created` |
| ç®¡ç†å‘˜å…¨å±€åˆ—è¡¨ | `ORDER BY created_at DESC LIMIT 50` | `idx_created_at` |
| é€šè¿‡è®¢å•å·æŸ¥æ‰¾ | `WHERE related_id = ?` | `idx_related_id` |
| ç»Ÿè®¡æŸç”¨æˆ·æ€»å……å€¼ | `WHERE user_id = ? AND amount > 0` | `idx_user_created` |
| æ—¥æœŸèŒƒå›´æŠ¥è¡¨ | `WHERE created_at BETWEEN ? AND ?` | `idx_created_at` |

```sql
-- ä¸»æŸ¥è¯¢ç´¢å¼•ï¼šç”¨æˆ·è®°å½•åˆ—è¡¨ï¼ˆæœ€å¸¸ç”¨ï¼‰
CREATE INDEX idx_recharge_records_user_created ON recharge_records(user_id, created_at DESC);

-- ç±»å‹+æ—¶é—´å¤åˆç´¢å¼•ï¼šç®¡ç†å‘˜æŒ‰ç±»å‹ç­›é€‰
CREATE INDEX idx_recharge_records_type_created ON recharge_records(type, created_at DESC);

-- æ—¶é—´ç´¢å¼•ï¼šå…¨å±€åˆ—è¡¨ã€æŠ¥è¡¨æŸ¥è¯¢
CREATE INDEX idx_recharge_records_created_at ON recharge_records(created_at DESC);

-- å…³è”IDç´¢å¼•ï¼šè®¢å•å·/å…‘æ¢ç åæŸ¥
CREATE INDEX idx_recharge_records_related_id ON recharge_records(related_id) WHERE related_id IS NOT NULL;

-- å¯é€‰ï¼šç”¨æˆ·+ç±»å‹å¤åˆç´¢å¼•ï¼ˆå¦‚æœå¸¸æŒ‰ç±»å‹ç­›é€‰ç”¨æˆ·è®°å½•ï¼‰
-- CREATE INDEX idx_recharge_records_user_type ON recharge_records(user_id, type, created_at DESC);
```

**æ‰©å±•æ€§è€ƒè™‘ï¼š**
- `related_id` ä½¿ç”¨ VARCHAR è€Œéå¤–é”®ï¼Œæ”¯æŒå…³è”ä¸åŒç±»å‹çš„ä¸šåŠ¡ï¼ˆè®¢å•ã€å…‘æ¢ç ç­‰ï¼‰
- `type` ä½¿ç”¨ VARCHAR ä¾¿äºæ‰©å±•æ–°ç±»å‹
- ä¿ç•™ä½™é¢å¿«ç…§ä¾¿äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥
- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼• `WHERE related_id IS NOT NULL` å‡å°‘ç´¢å¼•å¤§å°

---

### 3.4 user_promotions è¡¨ï¼ˆç”¨æˆ·æ´»åŠ¨çŠ¶æ€ï¼‰

**ç”¨é€”ï¼š** è®°å½•æ¯ä¸ªç”¨æˆ·çš„æ´»åŠ¨èµ„æ ¼å’Œä½¿ç”¨çŠ¶æ€ï¼Œä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€æ¡è®°å½•ã€‚

```sql
CREATE TABLE user_promotions (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    username        VARCHAR(100),

    -- æ´»åŠ¨æ—¶é—´çª—å£
    activated_at    TIMESTAMPTZ NOT NULL,       -- æ´»åŠ¨å¼€å§‹æ—¶é—´ï¼ˆ=æ³¨å†Œæ—¶é—´ï¼‰
    expire_at       TIMESTAMPTZ NOT NULL,       -- æ´»åŠ¨è¿‡æœŸæ—¶é—´
    status          VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/used/expired

    -- ä½¿ç”¨ä¿¡æ¯
    used_tier       INT,                        -- å·²ä½¿ç”¨çš„å±‚çº§ (0-3)
    used_at         TIMESTAMPTZ,
    used_amount     DECIMAL(20, 8),             -- ä½¿ç”¨æ—¶çš„å……å€¼é‡‘é¢
    bonus_amount    DECIMAL(20, 8),             -- è·å¾—çš„èµ é€é‡‘é¢

    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**æ´»åŠ¨å±‚çº§è¯´æ˜ï¼š**

| å±‚çº§ (tier) | æ—¶é—´çª—å£ | èµ é€æ¯”ä¾‹ | è¯´æ˜ |
|------------|---------|---------|------|
| 0 | æ³¨å†Œå 24 å°æ—¶å†… | 30% | é¦–æ—¥æœ€é«˜å¥–åŠ± |
| 1 | æ³¨å†Œå 36 å°æ—¶å†… | 20% | |
| 2 | æ³¨å†Œå 48 å°æ—¶å†… | 10% | |
| 3 | æ³¨å†Œå 72 å°æ—¶å†… | 5% | æœ€åæœºä¼š |

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• |
|---------|---------|------|
| ç”¨æˆ·å……å€¼æ—¶æŸ¥è¯¢æ´»åŠ¨çŠ¶æ€ | `WHERE user_id = ?` | `UNIQUE(user_id)` (ä¸»é”®çº§åˆ«) |
| å®šæ—¶ä»»åŠ¡ï¼šè¿‡æœŸæ´»åŠ¨æ›´æ–° | `WHERE status = 'active' AND expire_at < NOW()` | `idx_status_expire` |
| ç»Ÿè®¡æ´»è·ƒæ´»åŠ¨æ•°é‡ | `WHERE status = 'active'` | `idx_status_expire` |

```sql
-- user_id å·²æœ‰ UNIQUE çº¦æŸï¼Œè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæ— éœ€é¢å¤–ç´¢å¼•

-- çŠ¶æ€+è¿‡æœŸæ—¶é—´å¤åˆç´¢å¼•ï¼šå®šæ—¶ä»»åŠ¡æ‰¹é‡æ›´æ–°è¿‡æœŸæ´»åŠ¨
CREATE INDEX idx_user_promotions_status_expire ON user_promotions(status, expire_at)
    WHERE status = 'active';

-- å¯é€‰ï¼šå¦‚æœéœ€è¦æŒ‰å±‚çº§ç»Ÿè®¡
-- CREATE INDEX idx_user_promotions_used_tier ON user_promotions(used_tier) WHERE used_tier IS NOT NULL;
```

**æ‰©å±•æ€§è€ƒè™‘ï¼š**
- ä½¿ç”¨ `status` æšä¸¾ä¾¿äºæ‰©å±•æ–°çŠ¶æ€
- `used_tier` ä½¿ç”¨ INT ä¾¿äºé…ç½®åŒ–å±‚çº§æ•°é‡
- æœªæ¥å¯æ·»åŠ  `promotion_id` æ”¯æŒå¤šä¸ªæ´»åŠ¨
- éƒ¨åˆ†ç´¢å¼• `WHERE status = 'active'` åªç´¢å¼•æ´»è·ƒè®°å½•ï¼Œå‡å°‘ç´¢å¼•å¤§å°

---

### 3.5 promotion_records è¡¨ï¼ˆæ´»åŠ¨ä½¿ç”¨è®°å½•ï¼‰

**ç”¨é€”ï¼š** è®°å½•æ´»åŠ¨ä½¿ç”¨çš„å†å²ï¼Œç”¨äºç»Ÿè®¡åˆ†æã€‚

```sql
CREATE TABLE promotion_records (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    username        VARCHAR(100),

    tier            INT NOT NULL,               -- ä½¿ç”¨çš„å±‚çº§
    amount          DECIMAL(20, 8) NOT NULL,    -- å……å€¼é‡‘é¢
    bonus           DECIMAL(20, 8) NOT NULL,    -- èµ é€é‡‘é¢

    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• |
|---------|---------|------|
| ç»Ÿè®¡æ€»èµ é€é‡‘é¢ | `SELECT SUM(bonus)` | å…¨è¡¨æ‰«æï¼ˆæ•°æ®é‡å°ï¼‰ |
| æŒ‰å±‚çº§ç»Ÿè®¡ | `WHERE tier = ? GROUP BY ...` | `idx_tier_created` |
| æŒ‰æ—¶é—´èŒƒå›´ç»Ÿè®¡ | `WHERE created_at BETWEEN ? AND ?` | `idx_created_at` |
| æŸ¥çœ‹æŸç”¨æˆ·æ´»åŠ¨è®°å½• | `WHERE user_id = ?` | `idx_user_id` |

```sql
-- ç”¨æˆ·è®°å½•æŸ¥è¯¢
CREATE INDEX idx_promotion_records_user_id ON promotion_records(user_id);

-- æ—¶é—´èŒƒå›´ç»Ÿè®¡
CREATE INDEX idx_promotion_records_created_at ON promotion_records(created_at DESC);

-- æŒ‰å±‚çº§+æ—¶é—´ç»Ÿè®¡ï¼ˆç”¨äºåˆ†æå„å±‚çº§ä½¿ç”¨æƒ…å†µï¼‰
CREATE INDEX idx_promotion_records_tier_created ON promotion_records(tier, created_at DESC);
```

**æ³¨æ„ï¼š** æ­¤è¡¨æ•°æ®é‡é€šå¸¸è¾ƒå°ï¼ˆæ¯ç”¨æˆ·æœ€å¤šä¸€æ¡ï¼‰ï¼Œç´¢å¼•ä¸»è¦ç”¨äºç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–ã€‚

---

### 3.6 referral_codes è¡¨ï¼ˆé‚€è¯·ç ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·çš„å”¯ä¸€é‚€è¯·ç ã€‚

```sql
CREATE TABLE referral_codes (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    code            VARCHAR(20) NOT NULL UNIQUE,

    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• |
|---------|---------|------|
| ç”¨æˆ·æ³¨å†Œæ—¶éªŒè¯é‚€è¯·ç  | `WHERE code = ?` | `UNIQUE(code)` â­é«˜é¢‘ |
| ç”¨æˆ·è·å–è‡ªå·±çš„é‚€è¯·ç  | `WHERE user_id = ?` | `UNIQUE(user_id)` |

```sql
-- UNIQUE çº¦æŸè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæ— éœ€é¢å¤–ç´¢å¼•
-- user_id UNIQUE â†’ è‡ªåŠ¨åˆ›å»º idx_referral_codes_user_id
-- code UNIQUE â†’ è‡ªåŠ¨åˆ›å»º idx_referral_codes_code

-- å¦‚æœé‚€è¯·ç æŸ¥è¯¢æ˜¯é«˜é¢‘æ“ä½œï¼Œå¯è€ƒè™‘ Redis ç¼“å­˜ï¼Œè€Œéé¢å¤–ç´¢å¼•
```

**æ‰©å±•æ€§è€ƒè™‘ï¼š**
- æœªæ¥å¯æ·»åŠ  `expires_at` æ”¯æŒæœ‰æ—¶æ•ˆçš„é‚€è¯·ç 
- æœªæ¥å¯æ·»åŠ  `max_uses` æ”¯æŒé™æ¬¡é‚€è¯·ç 
- é‚€è¯·ç æŸ¥è¯¢é«˜é¢‘ï¼Œå»ºè®®åœ¨ Redis ä¸­ç¼“å­˜ `code â†’ user_id` æ˜ å°„

---

### 3.7 referral_invites è¡¨ï¼ˆé‚€è¯·å…³ç³»ï¼‰

**ç”¨é€”ï¼š** è®°å½•é‚€è¯·äººä¸è¢«é‚€è¯·äººçš„å…³ç³»ï¼Œä»¥åŠè¿”åˆ©çŠ¶æ€ã€‚

```sql
CREATE TABLE referral_invites (
    id                  BIGSERIAL PRIMARY KEY,

    -- é‚€è¯·å…³ç³»
    invitee_id          BIGINT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    invitee_username    VARCHAR(100),
    referrer_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    referrer_username   VARCHAR(100),

    -- è¢«é‚€è¯·äººå……å€¼ç»Ÿè®¡
    total_recharge_usd  DECIMAL(20, 8) NOT NULL DEFAULT 0,

    -- è¿”åˆ©çŠ¶æ€
    is_qualified        BOOLEAN NOT NULL DEFAULT FALSE,
    qualified_at        TIMESTAMPTZ,
    reward_issued       BOOLEAN NOT NULL DEFAULT FALSE,
    reward_issued_at    TIMESTAMPTZ,
    reward_amount_usd   DECIMAL(20, 8) NOT NULL DEFAULT 0,

    created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `invitee_id` | è¢«é‚€è¯·äººï¼ˆä¸€ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ï¼ŒUNIQUEï¼‰ |
| `referrer_id` | é‚€è¯·äºº |
| `total_recharge_usd` | è¢«é‚€è¯·äººé€šè¿‡åœ¨çº¿æ”¯ä»˜çš„ç´¯è®¡å……å€¼ |
| `is_qualified` | æ˜¯å¦è¾¾åˆ°è¿”åˆ©æ¡ä»¶ |
| `reward_issued` | è¿”åˆ©æ˜¯å¦å·²å‘æ”¾ç»™é‚€è¯·äºº |

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• |
|---------|---------|------|
| è¢«é‚€è¯·äººå……å€¼æ—¶æŸ¥è¯¢é‚€è¯·å…³ç³» | `WHERE invitee_id = ?` | `UNIQUE(invitee_id)` â­é«˜é¢‘ |
| é‚€è¯·äººæŸ¥çœ‹è¢«é‚€è¯·äººåˆ—è¡¨ | `WHERE referrer_id = ? ORDER BY created_at DESC` | `idx_referrer_created` |
| ç»Ÿè®¡é‚€è¯·äººçš„æ€»é‚€è¯·æ•° | `WHERE referrer_id = ? GROUP BY ...` | `idx_referrer_created` |
| æŸ¥è¯¢å¾…å‘æ”¾è¿”åˆ© | `WHERE is_qualified = true AND reward_issued = false` | `idx_pending_reward` |
| ç»Ÿè®¡å·²å‘æ”¾è¿”åˆ©æ€»é¢ | `WHERE reward_issued = true` | `idx_pending_reward` |

```sql
-- invitee_id å·²æœ‰ UNIQUE çº¦æŸï¼Œè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•

-- é‚€è¯·äºº+æ—¶é—´å¤åˆç´¢å¼•ï¼šæŸ¥çœ‹è¢«é‚€è¯·äººåˆ—è¡¨ï¼ˆæœ€å¸¸ç”¨ï¼‰
CREATE INDEX idx_referral_invites_referrer_created ON referral_invites(referrer_id, created_at DESC);

-- å¾…å‘æ”¾è¿”åˆ©æŸ¥è¯¢ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼Œåªç´¢å¼•ç¬¦åˆæ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_referral_invites_pending_reward ON referral_invites(is_qualified, reward_issued)
    WHERE is_qualified = true AND reward_issued = false;

-- é‚€è¯·äººç»Ÿè®¡ç´¢å¼•ï¼ˆINCLUDE è¦†ç›–å¸¸ç”¨å­—æ®µï¼Œé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_referral_invites_referrer_stats ON referral_invites(referrer_id)
    INCLUDE (is_qualified, reward_issued, reward_amount_usd);
```

**æ‰©å±•æ€§è€ƒè™‘ï¼š**
- `total_recharge_usd` å¯æŒ‰ç±»å‹ç»Ÿè®¡ï¼Œæœªæ¥å¯æ‹†åˆ†ä¸º `payment_recharge` å’Œ `redeem_recharge`
- æœªæ¥å¯æ·»åŠ å¤šçº§è¿”åˆ©æ”¯æŒï¼ˆ`level` å­—æ®µï¼‰
- ä½¿ç”¨ `INCLUDE` è¦†ç›–ç´¢å¼•å‡å°‘ç»Ÿè®¡æŸ¥è¯¢çš„å›è¡¨å¼€é”€

---

### 3.8 payment_orders è¡¨ï¼ˆæ”¯ä»˜è®¢å•ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨æ‰€æœ‰æ”¯ä»˜è®¢å•ä¿¡æ¯ã€‚

```sql
CREATE TABLE payment_orders (
    id              BIGSERIAL PRIMARY KEY,
    order_no        VARCHAR(50) NOT NULL UNIQUE,    -- å†…éƒ¨è®¢å•å·
    trade_no        VARCHAR(100) UNIQUE,            -- æ”¯ä»˜å¹³å°äº¤æ˜“å·
    user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    username        VARCHAR(100),

    -- é‡‘é¢ä¿¡æ¯ï¼ˆæ ¸å¿ƒï¼‰
    amount_cny      DECIMAL(20, 2) NOT NULL,        -- æ”¯ä»˜é‡‘é¢ (CNY)
    amount_usd      DECIMAL(20, 8) NOT NULL,        -- æŠ˜ç®—é‡‘é¢ (USD)
    bonus_usd       DECIMAL(20, 8) NOT NULL DEFAULT 0,  -- æ´»åŠ¨èµ é€ (USD)
    total_usd       DECIMAL(20, 8) NOT NULL,        -- å®é™…åˆ°è´¦ (USD)
    exchange_rate   DECIMAL(10, 4) NOT NULL,        -- å½“æ—¶æ±‡ç‡

    -- æ”¯ä»˜æ¸ é“ä¿¡æ¯
    provider        VARCHAR(20) NOT NULL,           -- zpay/stripe
    payment_method  VARCHAR(50),                    -- alipay/wechat/card
    payment_url     VARCHAR(1000),                  -- æ”¯ä»˜é“¾æ¥/äºŒç»´ç 

    -- è®¢å•çŠ¶æ€
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',
    paid_at         TIMESTAMPTZ,
    expire_at       TIMESTAMPTZ NOT NULL,

    -- æ´»åŠ¨ä¿¡æ¯
    promotion_tier  INT,                            -- ä½¿ç”¨çš„æ´»åŠ¨å±‚çº§
    promotion_used  BOOLEAN NOT NULL DEFAULT FALSE,

    -- å›è°ƒä¿¡æ¯
    callback_data   TEXT,                           -- å›è°ƒåŸå§‹æ•°æ® (JSON)
    callback_at     TIMESTAMPTZ,

    -- å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆç”¨äºé£æ§ï¼‰
    client_ip       VARCHAR(50),
    user_agent      VARCHAR(500),

    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**è®¢å•çŠ¶æ€æµè½¬ï¼š**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ pending  â”‚ â† åˆ›å»ºè®¢å•
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   paid   â”‚   â”‚  failed  â”‚   â”‚ expired  â”‚
    â”‚ (å·²æ”¯ä»˜) â”‚   â”‚ (å¤±è´¥)   â”‚   â”‚ (è¿‡æœŸ)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ refunded â”‚ â† å¯é€‰ï¼šé€€æ¬¾
    â”‚ (å·²é€€æ¬¾) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢åœºæ™¯åˆ†æï¼š**

| æŸ¥è¯¢åœºæ™¯ | SQL ç¤ºä¾‹ | ç´¢å¼• | é¢‘ç‡ |
|---------|---------|------|------|
| æ”¯ä»˜å›è°ƒæŸ¥è¯¢ | `WHERE order_no = ?` | `UNIQUE(order_no)` | â­â­â­ æé«˜ |
| æ”¯ä»˜å¹³å°äº¤æ˜“å·æŸ¥è¯¢ | `WHERE trade_no = ?` | `UNIQUE(trade_no)` | â­â­ é«˜ |
| ç”¨æˆ·è®¢å•åˆ—è¡¨ | `WHERE user_id = ? ORDER BY created_at DESC` | `idx_user_created` | â­â­â­ æé«˜ |
| ç”¨æˆ·æŒ‰çŠ¶æ€ç­›é€‰è®¢å• | `WHERE user_id = ? AND status = ?` | `idx_user_status_created` | â­â­ é«˜ |
| ç®¡ç†å‘˜å…¨å±€è®¢å•åˆ—è¡¨ | `ORDER BY created_at DESC` | `idx_created_at` | â­ ä¸­ |
| ç®¡ç†å‘˜æŒ‰çŠ¶æ€ç­›é€‰ | `WHERE status = ? ORDER BY created_at DESC` | `idx_status_created` | â­ ä¸­ |
| ç®¡ç†å‘˜æŒ‰æ¸ é“ç­›é€‰ | `WHERE provider = ? ORDER BY created_at DESC` | `idx_provider_created` | â­ ä½ |
| è¿‡æœŸè®¢å•æ¸…ç†ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ | `WHERE status = 'pending' AND expire_at < NOW()` | `idx_pending_expire` | â­ ä½ï¼ˆä½†è¦å¿«ï¼‰ |
| ç»Ÿè®¡ä»Šæ—¥è®¢å•é‡‘é¢ | `WHERE status = 'paid' AND paid_at >= ?` | `idx_paid_at` | â­ ä½ |

```sql
-- ==================== æ ¸å¿ƒç´¢å¼• ====================

-- è®¢å•å·å”¯ä¸€ç´¢å¼•ï¼ˆå›è°ƒæŸ¥è¯¢ï¼Œæé«˜é¢‘ï¼‰
-- UNIQUE çº¦æŸè‡ªåŠ¨åˆ›å»º

-- æ”¯ä»˜å¹³å°äº¤æ˜“å·å”¯ä¸€ç´¢å¼•ï¼ˆå¹³å°ä¾§æŸ¥è¯¢ï¼‰
-- UNIQUE çº¦æŸè‡ªåŠ¨åˆ›å»ºï¼Œå…è®¸ NULL

-- ç”¨æˆ·è®¢å•åˆ—è¡¨ï¼ˆæœ€å¸¸ç”¨æŸ¥è¯¢ï¼‰
CREATE INDEX idx_payment_orders_user_created ON payment_orders(user_id, created_at DESC);

-- ç”¨æˆ·+çŠ¶æ€+æ—¶é—´å¤åˆç´¢å¼•ï¼ˆç­›é€‰ç‰¹å®šçŠ¶æ€è®¢å•ï¼‰
CREATE INDEX idx_payment_orders_user_status_created ON payment_orders(user_id, status, created_at DESC);

-- ==================== ç®¡ç†åå°ç´¢å¼• ====================

-- å…¨å±€æ—¶é—´ç´¢å¼•ï¼ˆç®¡ç†å‘˜åˆ—è¡¨ï¼‰
CREATE INDEX idx_payment_orders_created_at ON payment_orders(created_at DESC);

-- çŠ¶æ€+æ—¶é—´å¤åˆç´¢å¼•ï¼ˆæŒ‰çŠ¶æ€ç­›é€‰ï¼‰
CREATE INDEX idx_payment_orders_status_created ON payment_orders(status, created_at DESC);

-- æ¸ é“+çŠ¶æ€+æ—¶é—´ï¼ˆæŒ‰æ¸ é“ç»Ÿè®¡ï¼‰
CREATE INDEX idx_payment_orders_provider_status ON payment_orders(provider, status, created_at DESC);

-- ==================== å®šæ—¶ä»»åŠ¡ç´¢å¼• ====================

-- è¿‡æœŸè®¢å•æ¸…ç†ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼Œåªç´¢å¼• pending çŠ¶æ€ï¼‰
CREATE INDEX idx_payment_orders_pending_expire ON payment_orders(expire_at)
    WHERE status = 'pending';

-- ==================== ç»Ÿè®¡æŠ¥è¡¨ç´¢å¼• ====================

-- å·²æ”¯ä»˜è®¢å•æŒ‰æ—¶é—´ç»Ÿè®¡ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
CREATE INDEX idx_payment_orders_paid_stats ON payment_orders(paid_at DESC)
    INCLUDE (amount_cny, amount_usd, bonus_usd, total_usd, provider)
    WHERE status = 'paid';
```

**ç´¢å¼•ä¼˜åŒ–è¯´æ˜ï¼š**

| ä¼˜åŒ–æŠ€æœ¯ | åº”ç”¨åœºæ™¯ | è¯´æ˜ |
|---------|---------|------|
| éƒ¨åˆ†ç´¢å¼• (Partial Index) | è¿‡æœŸè®¢å•ã€å·²æ”¯ä»˜ç»Ÿè®¡ | åªç´¢å¼•ç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œå‡å°‘ç´¢å¼•å¤§å° |
| è¦†ç›–ç´¢å¼• (INCLUDE) | ç»Ÿè®¡æŠ¥è¡¨ | é¿å…å›è¡¨ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ |
| å¤åˆç´¢å¼•é¡ºåº | user_id + status + created_at | éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢ |
| é™åºç´¢å¼• | created_at DESC | é€‚é… `ORDER BY ... DESC LIMIT N` åœºæ™¯ |

**æ‰©å±•æ€§è€ƒè™‘ï¼š**
- `callback_data` å­˜å‚¨åŸå§‹ JSONï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- `client_ip` å’Œ `user_agent` ç”¨äºé£æ§åˆ†æ
- é¢„ç•™ `promotion_tier` å’Œ `promotion_used` ä¾¿äºæ´»åŠ¨å…³è”
- æœªæ¥å¯æ·»åŠ  `refund_amount`, `refund_at` æ”¯æŒéƒ¨åˆ†é€€æ¬¾
- å¤§è¡¨åœºæ™¯å¯è€ƒè™‘æŒ‰æ—¶é—´åˆ†åŒºï¼ˆå¦‚æŒ‰æœˆåˆ†åŒºï¼‰

---

### 3.9 ç´¢å¼•è®¾è®¡æ€»ç»“

#### ç´¢å¼•æ¸…å•æ±‡æ€»

| è¡¨ | ç´¢å¼•å | ç±»å‹ | è¯´æ˜ |
|---|--------|------|------|
| **recharge_records** | | | |
| | `idx_recharge_records_user_created` | B-tree å¤åˆ | ç”¨æˆ·è®°å½•åˆ—è¡¨ï¼ˆä¸»æŸ¥è¯¢ï¼‰ |
| | `idx_recharge_records_type_created` | B-tree å¤åˆ | æŒ‰ç±»å‹ç­›é€‰ |
| | `idx_recharge_records_created_at` | B-tree | å…¨å±€åˆ—è¡¨ |
| | `idx_recharge_records_related_id` | B-tree éƒ¨åˆ† | å…³è”IDæŸ¥è¯¢ |
| **user_promotions** | | | |
| | `(user_id)` | Unique | è‡ªåŠ¨åˆ›å»º |
| | `idx_user_promotions_status_expire` | B-tree éƒ¨åˆ† | è¿‡æœŸæ¸…ç†ä»»åŠ¡ |
| **promotion_records** | | | |
| | `idx_promotion_records_user_id` | B-tree | ç”¨æˆ·è®°å½• |
| | `idx_promotion_records_created_at` | B-tree | æ—¶é—´èŒƒå›´ |
| | `idx_promotion_records_tier_created` | B-tree å¤åˆ | å±‚çº§ç»Ÿè®¡ |
| **referral_codes** | | | |
| | `(user_id)` | Unique | è‡ªåŠ¨åˆ›å»º |
| | `(code)` | Unique | è‡ªåŠ¨åˆ›å»º |
| **referral_invites** | | | |
| | `(invitee_id)` | Unique | è‡ªåŠ¨åˆ›å»º |
| | `idx_referral_invites_referrer_created` | B-tree å¤åˆ | è¢«é‚€è¯·äººåˆ—è¡¨ |
| | `idx_referral_invites_pending_reward` | B-tree éƒ¨åˆ† | å¾…å‘æ”¾è¿”åˆ© |
| | `idx_referral_invites_referrer_stats` | B-tree + INCLUDE | ç»Ÿè®¡è¦†ç›–ç´¢å¼• |
| **payment_orders** | | | |
| | `(order_no)` | Unique | è‡ªåŠ¨åˆ›å»º |
| | `(trade_no)` | Unique | è‡ªåŠ¨åˆ›å»º |
| | `idx_payment_orders_user_created` | B-tree å¤åˆ | ç”¨æˆ·è®¢å•åˆ—è¡¨ |
| | `idx_payment_orders_user_status_created` | B-tree å¤åˆ | ç”¨æˆ·æŒ‰çŠ¶æ€ç­›é€‰ |
| | `idx_payment_orders_created_at` | B-tree | å…¨å±€åˆ—è¡¨ |
| | `idx_payment_orders_status_created` | B-tree å¤åˆ | æŒ‰çŠ¶æ€ç­›é€‰ |
| | `idx_payment_orders_provider_status` | B-tree å¤åˆ | æŒ‰æ¸ é“ç»Ÿè®¡ |
| | `idx_payment_orders_pending_expire` | B-tree éƒ¨åˆ† | è¿‡æœŸæ¸…ç†ä»»åŠ¡ |
| | `idx_payment_orders_paid_stats` | B-tree + INCLUDE éƒ¨åˆ† | ç»Ÿè®¡æŠ¥è¡¨ |

#### æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

| ä¼˜åŒ–ç­–ç•¥ | è¯´æ˜ | åº”ç”¨åœºæ™¯ |
|---------|------|---------|
| **éƒ¨åˆ†ç´¢å¼• (Partial Index)** | åªç´¢å¼•æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œå‡å°‘ç´¢å¼•å¤§å°å’Œç»´æŠ¤å¼€é”€ | è¿‡æœŸè®¢å•æ¸…ç†ã€æ´»è·ƒæ´»åŠ¨æŸ¥è¯¢ |
| **è¦†ç›–ç´¢å¼• (INCLUDE)** | å°†å¸¸ç”¨å­—æ®µåŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œé¿å…å›è¡¨æŸ¥è¯¢ | ç»Ÿè®¡æŠ¥è¡¨ã€åˆ—è¡¨å±•ç¤º |
| **å¤åˆç´¢å¼•åˆ—é¡ºåº** | éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼Œç­‰å€¼æ¡ä»¶åœ¨å‰ï¼ŒèŒƒå›´æ¡ä»¶åœ¨å | user_id + status + created_at |
| **é™åºç´¢å¼•** | é€‚é… `ORDER BY ... DESC LIMIT N` åœºæ™¯ | åˆ†é¡µåˆ—è¡¨æŸ¥è¯¢ |
| **Redis ç¼“å­˜** | é«˜é¢‘è¯»å–çš„çƒ­ç‚¹æ•°æ®ä½¿ç”¨ Redis ç¼“å­˜ | é‚€è¯·ç æŸ¥è¯¢ã€ç”¨æˆ·æ´»åŠ¨çŠ¶æ€ |

#### é¢„æœŸæ•°æ®é‡ä¸åˆ†åŒºç­–ç•¥

| è¡¨ | é¢„æœŸæ•°æ®é‡/æœˆ | å¢é•¿è¶‹åŠ¿ | å»ºè®®ç­–ç•¥ |
|---|-------------|---------|---------|
| `recharge_records` | ç”¨æˆ·æ•° Ã— 10 | çº¿æ€§å¢é•¿ | 1å¹´åè€ƒè™‘æŒ‰æœˆåˆ†åŒº |
| `user_promotions` | ç­‰äºç”¨æˆ·æ•° | ç¼“æ…¢å¢é•¿ | æ— éœ€åˆ†åŒº |
| `promotion_records` | ç”¨æˆ·æ•° Ã— 0.3 | ç¼“æ…¢å¢é•¿ | æ— éœ€åˆ†åŒº |
| `referral_codes` | ç­‰äºç”¨æˆ·æ•° | ç¼“æ…¢å¢é•¿ | æ— éœ€åˆ†åŒº |
| `referral_invites` | ç”¨æˆ·æ•° Ã— 0.5 | ç¼“æ…¢å¢é•¿ | æ— éœ€åˆ†åŒº |
| `payment_orders` | ç”¨æˆ·æ•° Ã— 5 | çº¿æ€§å¢é•¿ | 1å¹´åè€ƒè™‘æŒ‰æœˆåˆ†åŒº |

#### åˆ†åŒºè¡¨ç¤ºä¾‹ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

```sql
-- å¦‚æœ payment_orders æ•°æ®é‡è¶…è¿‡ 1000 ä¸‡ï¼Œè€ƒè™‘æŒ‰æœˆåˆ†åŒº
CREATE TABLE payment_orders (
    -- ... å­—æ®µå®šä¹‰ ...
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE payment_orders_2024_01 PARTITION OF payment_orders
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE payment_orders_2024_02 PARTITION OF payment_orders
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ...
```

---

## å››ã€è¡¨å…³è”å…³ç³»å›¾

### 4.1 å®Œæ•´ ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    æ•°æ®åº“è¡¨å…³è”å…³ç³»å›¾                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                              â”‚       users         â”‚                                   â”‚
â”‚                              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                   â”‚
â”‚                              â”‚  id (PK)            â”‚                                   â”‚
â”‚                              â”‚  email              â”‚                                   â”‚
â”‚                              â”‚  balance â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ ä½™é¢å­—æ®µï¼ˆå·²æœ‰ï¼‰              â”‚
â”‚                              â”‚  ...                â”‚                                   â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                         â”‚                                              â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚        â”‚                â”‚               â”‚               â”‚                â”‚             â”‚
â”‚        â–¼                â–¼               â–¼               â–¼                â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ recharge_ â”‚   â”‚   user_   â”‚   â”‚ referral_ â”‚   â”‚ referral_ â”‚   â”‚ payment_  â”‚        â”‚
â”‚  â”‚ records   â”‚   â”‚promotions â”‚   â”‚   codes   â”‚   â”‚  invites  â”‚   â”‚  orders   â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ id (PK)   â”‚   â”‚ id (PK)   â”‚   â”‚ id (PK)   â”‚   â”‚ id (PK)   â”‚   â”‚ id (PK)   â”‚        â”‚
â”‚  â”‚ user_id   â”‚   â”‚ user_id   â”‚   â”‚ user_id   â”‚   â”‚invitee_id â”‚   â”‚ user_id   â”‚        â”‚
â”‚  â”‚ (FK)      â”‚   â”‚ (FK,UQ)   â”‚   â”‚ (FK,UQ)   â”‚   â”‚ (FK,UQ)   â”‚   â”‚ (FK)      â”‚        â”‚
â”‚  â”‚ amount    â”‚   â”‚activated_ â”‚   â”‚ code (UQ) â”‚   â”‚referrer_idâ”‚   â”‚ order_no  â”‚        â”‚
â”‚  â”‚ type      â”‚   â”‚  at       â”‚   â”‚           â”‚   â”‚ (FK)      â”‚   â”‚ (UQ)      â”‚        â”‚
â”‚  â”‚ related_idâ”‚   â”‚ expire_at â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚is_qualif- â”‚   â”‚ amount_   â”‚        â”‚
â”‚  â”‚ balance_  â”‚   â”‚ status    â”‚                   â”‚  ied      â”‚   â”‚  cny/usd  â”‚        â”‚
â”‚  â”‚  before   â”‚   â”‚ used_tier â”‚                   â”‚reward_    â”‚   â”‚ bonus_usd â”‚        â”‚
â”‚  â”‚ balance_  â”‚   â”‚ bonus_    â”‚                   â”‚  issued   â”‚   â”‚ status    â”‚        â”‚
â”‚  â”‚  after    â”‚   â”‚  amount   â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ provider  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚                â”‚                              â”‚               â”‚               â”‚
â”‚        â”‚                â”‚                              â”‚               â”‚               â”‚
â”‚        â”‚                â–¼                              â”‚               â”‚               â”‚
â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚promotion_ â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ records   â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ id (PK)   â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ user_id   â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ tier      â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ amount    â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â”‚ bonus     â”‚                         â”‚               â”‚               â”‚
â”‚        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚               â”‚               â”‚
â”‚        â”‚                                               â”‚               â”‚               â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚                              related_id å¯å…³è”åˆ°:                                       â”‚
â”‚                              - payment_orders.order_no                                 â”‚
â”‚                              - redeem_codes.code                                       â”‚
â”‚                              - å…¶ä»–ä¸šåŠ¡ID                                               â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³è”å…³ç³»è¯´æ˜

| è¡¨ | å…³è” | å…³ç³»ç±»å‹ | è¯´æ˜ |
|---|------|---------|------|
| `recharge_records` â†’ `users` | `user_id` | N:1 | ä¸€ä¸ªç”¨æˆ·æœ‰å¤šæ¡å……å€¼è®°å½• |
| `user_promotions` â†’ `users` | `user_id` (UNIQUE) | 1:1 | ä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªæ´»åŠ¨çŠ¶æ€ |
| `promotion_records` â†’ `users` | `user_id` | N:1 | ä¸€ä¸ªç”¨æˆ·å¯æœ‰å¤šæ¡æ´»åŠ¨ä½¿ç”¨è®°å½• |
| `referral_codes` â†’ `users` | `user_id` (UNIQUE) | 1:1 | ä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªé‚€è¯·ç  |
| `referral_invites` â†’ `users` | `invitee_id` (UNIQUE) | 1:1 | ä¸€ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ |
| `referral_invites` â†’ `users` | `referrer_id` | N:1 | ä¸€ä¸ªé‚€è¯·äººå¯é‚€è¯·å¤šäºº |
| `payment_orders` â†’ `users` | `user_id` | N:1 | ä¸€ä¸ªç”¨æˆ·å¯æœ‰å¤šä¸ªè®¢å• |
| `recharge_records.related_id` â†’ å„ä¸šåŠ¡è¡¨ | è½¯å…³è” | - | é€šè¿‡å­—ç¬¦ä¸²IDå…³è” |

### 4.3 æ•°æ®æµå…³ç³»å›¾

```
ç”¨æˆ·æ³¨å†Œæµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚â”€â”€â”€â–ºâ”‚  user_promotions  â”‚    â”‚ referral_codesâ”‚
â”‚  æ³¨å†Œ    â”‚    â”‚  (åˆå§‹åŒ–æ´»åŠ¨)      â”‚    â”‚ (æŒ‰éœ€ç”Ÿæˆ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ å¦‚æœæœ‰é‚€è¯·ç 
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚referral_invitesâ”‚
â”‚ (è®°å½•é‚€è¯·å…³ç³») â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”¯ä»˜å……å€¼æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»º    â”‚â”€â”€â”€â–ºâ”‚payment_orders â”‚â”€â”€â”€â–ºâ”‚  æ”¯ä»˜æ¸ é“     â”‚
â”‚  è®¢å•    â”‚    â”‚ (pending)     â”‚    â”‚ (Zpay/Stripe) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ å›è°ƒ
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚recharge_recordsâ”‚â—„â”€â”€â”€â”‚payment_orders â”‚â—„â”€â”€â”€â”‚  æ›´æ–°è®¢å•     â”‚
â”‚ (è®°å½•æµæ°´)     â”‚    â”‚ (paid)        â”‚    â”‚  çŠ¶æ€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚
         â”‚                  â”‚ å¦‚æœæ˜¯é¦–æ¬¡å……å€¼ä¸”åœ¨æ´»åŠ¨æœŸ
         â”‚                  â–¼
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚user_promotionsâ”‚â”€â”€â”€â–ºâ”‚promotion_     â”‚
         â”‚           â”‚ (æ ‡è®°å·²ç”¨)    â”‚    â”‚  records      â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å¦‚æœè¢«é‚€è¯·äººå……å€¼è¾¾æ ‡
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚referral_invitesâ”‚â”€â”€â”€â–ºâ”‚recharge_recordsâ”‚
â”‚ (æ ‡è®°è¾¾æ ‡)     â”‚    â”‚ (é‚€è¯·äººè¿”åˆ©)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å„å±‚å®ç°æ¸…å•

### 5.1 Model å±‚

| åºå· | æ–‡ä»¶ | çŠ¶æ€ |
|-----|------|------|
| 1 | `internal/model/recharge_record.go` | â¬œ |
| 2 | `internal/model/promotion.go` | â¬œ |
| 3 | `internal/model/referral.go` | â¬œ |
| 4 | `internal/model/payment_order.go` | â¬œ |

### 5.2 æ•°æ®åº“è¿ç§»

| åºå· | æ–‡ä»¶ | çŠ¶æ€ |
|-----|------|------|
| 1 | `migrations/005_recharge_record.sql` | â¬œ |
| 2 | `migrations/006_promotion.sql` | â¬œ |
| 3 | `migrations/007_referral.sql` | â¬œ |
| 4 | `migrations/008_payment_order.sql` | â¬œ |

### 5.3 Repository å±‚

| åºå· | æ–‡ä»¶ | ä¸»è¦æ–¹æ³• | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `repository/recharge_record_repo.go` | Create, ListByUserID, ListAll | â¬œ |
| 2 | `repository/promotion_repo.go` | Create, GetByUserID, Update, CreateRecord | â¬œ |
| 3 | `repository/promotion_cache.go` | GetUserPromotion (Redis ç¼“å­˜) | â¬œ |
| 4 | `repository/referral_repo.go` | CreateCode, GetCodeByUserID, CreateInvite, UpdateInvite | â¬œ |
| 5 | `repository/referral_cache.go` | é‚€è¯·ç æŸ¥è¯¢ç¼“å­˜ | â¬œ |
| 6 | `repository/payment_order_repo.go` | Create, GetByOrderNo, GetByTradeNo, Update, List | â¬œ |
| 7 | `repository/payment_cache.go` | è®¢å•é€Ÿç‡é™åˆ¶ | â¬œ |

### 5.4 Service æ¥å£å±‚ (ports)

| åºå· | æ–‡ä»¶ | çŠ¶æ€ |
|-----|------|------|
| 1 | `service/ports/balance.go` | â¬œ |
| 2 | `service/ports/promotion.go` | â¬œ |
| 3 | `service/ports/referral.go` | â¬œ |
| 4 | `service/ports/payment.go` | â¬œ |
| 5 | `service/ports/zpay.go` | â¬œ |
| 6 | `service/ports/stripe.go` | â¬œ |

### 5.5 Service å®ç°å±‚

| åºå· | æ–‡ä»¶ | æ ¸å¿ƒèŒè´£ | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `service/balance_service.go` | ä½™é¢æ“ä½œå°è£… + è®°å½•æµæ°´ | â¬œ |
| 2 | `service/promotion_service.go` | æ´»åŠ¨åˆå§‹åŒ–ã€è¯„ä¼°ã€æ ‡è®°ä½¿ç”¨ | â¬œ |
| 3 | `service/referral_service.go` | é‚€è¯·ç ç®¡ç†ã€è¿”åˆ©å¤„ç† | â¬œ |
| 4 | `service/payment_service.go` | è®¢å•ç®¡ç†ã€å›è°ƒå¤„ç† | â¬œ |
| 5 | `service/zpay_service.go` | Zpay æ”¯ä»˜æ¸ é“å¯¹æ¥ | â¬œ |
| 6 | `service/stripe_service.go` | Stripe æ”¯ä»˜æ¸ é“å¯¹æ¥ | â¬œ |

### 5.6 Handler å±‚

| åºå· | æ–‡ä»¶ | API è·¯ç”± | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `handler/balance_handler.go` | GET /users/balance, /recharge-records | â¬œ |
| 2 | `handler/promotion_handler.go` | GET /users/promotion/status | â¬œ |
| 3 | `handler/referral_handler.go` | GET /users/referral/info, /invitees | â¬œ |
| 4 | `handler/payment_handler.go` | POST/GET /payment/* | â¬œ |
| 5 | `handler/admin/payment_handler.go` | GET /admin/payment/* | â¬œ |

### 5.7 Wire ä¾èµ–æ³¨å…¥

| åºå· | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `repository/wire.go` | æ·»åŠ æ–° Repository Provider | â¬œ |
| 2 | `service/wire.go` | æ·»åŠ æ–° Service Provider | â¬œ |
| 3 | `handler/wire.go` | æ·»åŠ æ–° Handler Provider | â¬œ |
| 4 | è¿è¡Œ `wire ./...` | é‡æ–°ç”Ÿæˆä¾èµ– | â¬œ |

### 5.8 è·¯ç”±æ³¨å†Œ

| åºå· | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `server/router.go` | æ³¨å†Œæ–°è·¯ç”± | â¬œ |

---

## å…­ã€é…ç½®æ‰©å±•

### 6.1 æ–°å¢é…ç½®ç»“æ„

éœ€è¦åœ¨ `internal/config/config.go` ä¸­æ·»åŠ ï¼š

```go
type Config struct {
    // ... ç°æœ‰é…ç½® ...

    Promotion PromotionConfig `mapstructure:"promotion"`
    Referral  ReferralConfig  `mapstructure:"referral"`
    Payment   PaymentConfig   `mapstructure:"payment"`
}

type PromotionConfig struct {
    Enabled       bool             `mapstructure:"enabled"`
    DurationHours int              `mapstructure:"duration_hours"`
    MinAmount     float64          `mapstructure:"min_amount"`
    Tiers         []PromotionTier  `mapstructure:"tiers"`
}

type PromotionTier struct {
    Hours        int     `mapstructure:"hours"`
    BonusPercent float64 `mapstructure:"bonus_percent"`
}

type ReferralConfig struct {
    Enabled              bool    `mapstructure:"enabled"`
    LinkBaseURL          string  `mapstructure:"link_base_url"`
    RewardUSD            float64 `mapstructure:"reward_usd"`
    QualifiedRechargeCNY float64 `mapstructure:"qualified_recharge_cny"`
    CodeLength           int     `mapstructure:"code_length"`
    MaxInviteesPerUser   int     `mapstructure:"max_invitees_per_user"`
}

type PaymentConfig struct {
    Enabled            bool             `mapstructure:"enabled"`
    BaseURL            string           `mapstructure:"base_url"`
    MinAmount          float64          `mapstructure:"min_amount"`
    MaxAmount          float64          `mapstructure:"max_amount"`
    ExchangeRate       float64          `mapstructure:"exchange_rate"`
    DiscountRate       float64          `mapstructure:"discount_rate"`
    OrderExpireMinutes int              `mapstructure:"order_expire_minutes"`
    MaxOrdersPerMinute int              `mapstructure:"max_orders_per_minute"`
    Packages           []PaymentPackage `mapstructure:"packages"`
    Zpay               ZpayConfig       `mapstructure:"zpay"`
    Stripe             StripeConfig     `mapstructure:"stripe"`
}

type PaymentPackage struct {
    AmountCNY float64 `mapstructure:"amount_cny"`
    Label     string  `mapstructure:"label"`
    Popular   bool    `mapstructure:"popular"`
}

type ZpayConfig struct {
    Enabled   bool   `mapstructure:"enabled"`
    PID       string `mapstructure:"pid"`
    Key       string `mapstructure:"key"`
    APIURL    string `mapstructure:"api_url"`
    NotifyURL string `mapstructure:"notify_url"`
    ReturnURL string `mapstructure:"return_url"`
}

type StripeConfig struct {
    Enabled       bool   `mapstructure:"enabled"`
    APIKey        string `mapstructure:"api_key"`
    WebhookSecret string `mapstructure:"webhook_secret"`
    SuccessURL    string `mapstructure:"success_url"`
    CancelURL     string `mapstructure:"cancel_url"`
}
```

### 6.2 é…ç½®æ–‡ä»¶ç¤ºä¾‹ (config.yaml)

```yaml
# æ´»åŠ¨ä¼˜æƒ é…ç½®
promotion:
  enabled: true
  duration_hours: 72
  min_amount: 0
  tiers:
    - hours: 24
      bonus_percent: 30
    - hours: 36
      bonus_percent: 20
    - hours: 48
      bonus_percent: 10
    - hours: 72
      bonus_percent: 5

# é‚€è¯·è¿”åˆ©é…ç½®
referral:
  enabled: true
  link_base_url: "https://your-domain.com/register"
  reward_usd: 10
  qualified_recharge_cny: 20
  code_length: 8
  max_invitees_per_user: 0  # 0=ä¸é™

# æ”¯ä»˜é…ç½®
payment:
  enabled: true
  base_url: "https://your-domain.com"
  min_amount: 1
  max_amount: 10000
  exchange_rate: 7.2
  discount_rate: 1
  order_expire_minutes: 30
  max_orders_per_minute: 3

  packages:
    - amount_cny: 10
      label: "Â¥10"
    - amount_cny: 50
      label: "Â¥50"
    - amount_cny: 100
      label: "Â¥100"
      popular: true
    - amount_cny: 500
      label: "Â¥500"

  zpay:
    enabled: true
    pid: ""
    key: ""
    api_url: "https://zpayz.cn"
    notify_url: "/api/payment/webhook/zpay"
    return_url: "/payment/result"

  stripe:
    enabled: false
    api_key: ""
    webhook_secret: ""
    success_url: "/payment/success"
    cancel_url: "/payment/cancel"
```

### 6.3 ç¯å¢ƒå˜é‡

```bash
# æ´»åŠ¨ä¼˜æƒ 
PROMOTION_ENABLED=true

# é‚€è¯·è¿”åˆ©
REFERRAL_ENABLED=true
REFERRAL_REWARD_USD=10

# æ”¯ä»˜
PAYMENT_ENABLED=true
PAYMENT_EXCHANGE_RATE=7.2

# Zpay
ZPAY_ENABLED=true
ZPAY_PID=your_pid
ZPAY_KEY=your_key

# Stripe
STRIPE_ENABLED=false
STRIPE_API_KEY=sk_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

---

## ä¸ƒã€ä¸šåŠ¡æµç¨‹é›†æˆ

### 7.1 ç”¨æˆ·æ³¨å†Œé›†æˆ

**ä¿®æ”¹æ–‡ä»¶ï¼š** `internal/service/auth_service.go`

```go
func (s *AuthService) Register(ctx context.Context, req *RegisterRequest) (*User, error) {
    // 1. åˆ›å»ºç”¨æˆ· (ç°æœ‰é€»è¾‘)
    user, err := s.createUser(ctx, req)
    if err != nil {
        return nil, err
    }

    // 2. åˆå§‹åŒ–æ´»åŠ¨ä¼˜æƒ  (æ–°å¢)
    if s.cfg.Promotion.Enabled {
        _ = s.promotionService.InitUserPromotion(ctx, user.ID, user.Username)
    }

    // 3. å¤„ç†é‚€è¯·ç  (æ–°å¢)
    if req.InviteCode != "" && s.cfg.Referral.Enabled {
        referrerID, err := s.referralService.FindUserIDByCode(ctx, req.InviteCode)
        if err == nil && referrerID > 0 {
            _ = s.referralService.RecordInvitation(ctx, &RecordInvitationRequest{
                InviteeID:        user.ID,
                InviteeUsername:  user.Username,
                ReferrerID:       referrerID,
            })
        }
    }

    return user, nil
}
```

### 7.2 æ”¯ä»˜å›è°ƒé›†æˆ

**æ–‡ä»¶ï¼š** `internal/service/payment_service.go`

```go
func (s *PaymentService) HandleCallback(ctx context.Context, provider string, data map[string]interface{}) error {
    // 1. éªŒè¯ç­¾å & è·å–è®¢å•
    order, err := s.verifyAndGetOrder(ctx, provider, data)
    if err != nil {
        return err
    }

    // 2. æ£€æŸ¥è®¢å•çŠ¶æ€
    if order.Status != PaymentStatusPending {
        return nil // å·²å¤„ç†ï¼Œå¹‚ç­‰è¿”å›
    }

    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    order.Status = PaymentStatusPaid
    order.PaidAt = timePtr(time.Now())
    order.TradeNo = getTradeNo(data)
    order.CallbackData = jsonString(data)

    // 4. è®¡ç®—æ´»åŠ¨ä¼˜æƒ 
    var bonusUSD float64
    if s.cfg.Promotion.Enabled {
        result, _ := s.promotionService.ApplyPromotion(ctx, order.UserID, order.AmountUSD)
        if result != nil && result.Applied {
            bonusUSD = result.Bonus
            order.PromotionTier = &result.Tier
        }
    }
    order.BonusUSD = bonusUSD
    order.TotalUSD = order.AmountUSD + bonusUSD

    // 5. å¼€å¯äº‹åŠ¡
    tx := s.db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()

    // 6. æ›´æ–°è®¢å•
    if err := tx.Save(order).Error; err != nil {
        tx.Rollback()
        return err
    }

    // 7. å……å€¼ä½™é¢ (è®°å½•æµæ°´)
    if err := s.balanceService.RechargeTx(tx, ctx, order.UserID, order.TotalUSD,
        RechargeTypePayment, "system", "åœ¨çº¿æ”¯ä»˜", &order.OrderNo); err != nil {
        tx.Rollback()
        return err
    }

    // 8. æ ‡è®°æ´»åŠ¨å·²ä½¿ç”¨
    if order.PromotionTier != nil {
        if err := s.promotionService.MarkPromotionUsedTx(tx, ctx, order.UserID,
            *order.PromotionTier, order.AmountUSD, bonusUSD); err != nil {
            tx.Rollback()
            return err
        }
        order.PromotionUsed = true
    }

    // 9. å¤„ç†é‚€è¯·è¿”åˆ©
    if s.cfg.Referral.Enabled {
        reward, _ := s.referralService.ProcessInviteeRechargeTx(tx, ctx, &RechargeRequest{
            InviteeID:        order.UserID,
            RechargeAmountUSD: order.AmountUSD,
            RecordType:       "payment",
        })
        if reward != nil && reward.ShouldIssue {
            // ç»™é‚€è¯·äººå‘æ”¾è¿”åˆ©
            _ = s.balanceService.RechargeTx(tx, ctx, reward.ReferrerID, reward.RewardAmountUSD,
                RechargeTypeReferral, "system", "é‚€è¯·è¿”åˆ©", nil)
            _ = s.referralService.MarkRewardIssuedTx(tx, ctx, order.UserID, reward.RewardAmountUSD)
        }
    }

    // 10. æäº¤äº‹åŠ¡
    if err := tx.Commit().Error; err != nil {
        return err
    }

    return nil
}
```

### 7.3 å®šæ—¶ä»»åŠ¡

**éœ€è¦æ·»åŠ çš„å®šæ—¶ä»»åŠ¡ï¼š**

| ä»»åŠ¡ | é¢‘ç‡ | è¯´æ˜ |
|------|------|------|
| è¿‡æœŸè®¢å•æ¸…ç† | æ¯ 5 åˆ†é’Ÿ | å°†è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•æ ‡è®°ä¸º expired |
| æ´»åŠ¨è¿‡æœŸæ›´æ–° | æ¯å°æ—¶ | å°†å·²è¿‡æœŸçš„æ´»åŠ¨çŠ¶æ€æ ‡è®°ä¸º expired |

```go
// è¿‡æœŸè®¢å•æ¸…ç†
func (s *PaymentService) CancelExpiredOrders(ctx context.Context) error {
    return s.orderRepo.UpdateExpiredOrders(ctx)
}

// SQL: UPDATE payment_orders SET status = 'expired', updated_at = NOW()
//      WHERE status = 'pending' AND expire_at < NOW()
```

---

## å…«ã€å‰ç«¯å¼€å‘æ¸…å•

### 8.1 API æ¨¡å—

| åºå· | æ–‡ä»¶ | çŠ¶æ€ |
|-----|------|------|
| 1 | `frontend/src/api/payment.ts` | â¬œ |
| 2 | `frontend/src/api/referral.ts` | â¬œ |

### 8.2 é¡µé¢ç»„ä»¶

| åºå· | æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|------|
| 1 | `views/user/PaymentView.vue` | å……å€¼é¡µé¢ | â¬œ |
| 2 | `views/user/RechargeRecordsView.vue` | å……å€¼è®°å½• | â¬œ |
| 3 | `views/user/ReferralView.vue` | é‚€è¯·è¿”åˆ©é¡µé¢ | â¬œ |
| 4 | `views/admin/PaymentOrdersView.vue` | è®¢å•ç®¡ç† | â¬œ |
| 5 | `components/PromotionBanner.vue` | æ´»åŠ¨æ¨ªå¹… | â¬œ |

### 8.3 è·¯ç”±é…ç½®

| åºå· | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|-----|------|---------|------|
| 1 | `router/index.ts` | æ·»åŠ æ–°è·¯ç”± | â¬œ |

### 8.4 å›½é™…åŒ–

| åºå· | æ–‡ä»¶ | çŠ¶æ€ |
|-----|------|------|
| 1 | `i18n/locales/zh.ts` | â¬œ |
| 2 | `i18n/locales/en.ts` | â¬œ |

---

## ä¹ã€æ‰§è¡Œé¡ºåºä¸è¿›åº¦

### 9.1 æ¨èæ‰§è¡Œé¡ºåº

```
Phase 1: æ•°æ®åº“å‡†å¤‡
â”œâ”€â”€ 1.1 è¿è¡Œè¿ç§»è„šæœ¬ (005-008)
â””â”€â”€ 1.2 éªŒè¯è¡¨ç»“æ„

Phase 2: Repository å±‚
â”œâ”€â”€ 2.1 recharge_record_repo.go
â”œâ”€â”€ 2.2 promotion_repo.go + cache
â”œâ”€â”€ 2.3 referral_repo.go + cache
â””â”€â”€ 2.4 payment_order_repo.go + cache

Phase 3: Service æ¥å£å®šä¹‰
â”œâ”€â”€ 3.1 ports/balance.go
â”œâ”€â”€ 3.2 ports/promotion.go
â”œâ”€â”€ 3.3 ports/referral.go
â”œâ”€â”€ 3.4 ports/payment.go
â””â”€â”€ 3.5 ports/zpay.go, stripe.go

Phase 4: Service å®ç°
â”œâ”€â”€ 4.1 balance_service.go
â”œâ”€â”€ 4.2 promotion_service.go
â”œâ”€â”€ 4.3 referral_service.go
â”œâ”€â”€ 4.4 payment_service.go
â”œâ”€â”€ 4.5 zpay_service.go
â””â”€â”€ 4.6 stripe_service.go

Phase 5: Handler å±‚
â”œâ”€â”€ 5.1 balance_handler.go
â”œâ”€â”€ 5.2 promotion_handler.go
â”œâ”€â”€ 5.3 referral_handler.go
â”œâ”€â”€ 5.4 payment_handler.go
â””â”€â”€ 5.5 admin/payment_handler.go

Phase 6: é›†æˆé…ç½®
â”œâ”€â”€ 6.1 config/config.go æ‰©å±•
â”œâ”€â”€ 6.2 Wire ä¾èµ–æ³¨å…¥
â”œâ”€â”€ 6.3 è·¯ç”±æ³¨å†Œ
â””â”€â”€ 6.4 å®šæ—¶ä»»åŠ¡

Phase 7: ä¸šåŠ¡é›†æˆ
â”œâ”€â”€ 7.1 auth_service.go é›†æˆ
â””â”€â”€ 7.2 æµ‹è¯•éªŒè¯

Phase 8: å‰ç«¯å¼€å‘
â”œâ”€â”€ 8.1 API æ¨¡å—
â”œâ”€â”€ 8.2 é¡µé¢ç»„ä»¶
â”œâ”€â”€ 8.3 è·¯ç”±é…ç½®
â””â”€â”€ 8.4 å›½é™…åŒ–
```

### 9.2 å½“å‰è¿›åº¦

| é˜¶æ®µ | æ€»ä»»åŠ¡ | å·²å®Œæˆ | è¿›åº¦ |
|------|-------|--------|------|
| Phase 1: æ•°æ®åº“ | 8 | 0 | 0% |
| Phase 2: Repository | 7 | 0 | 0% |
| Phase 3: Service æ¥å£ | 6 | 0 | 0% |
| Phase 4: Service å®ç° | 6 | 0 | 0% |
| Phase 5: Handler | 5 | 0 | 0% |
| Phase 6: é›†æˆé…ç½® | 4 | 0 | 0% |
| Phase 7: ä¸šåŠ¡é›†æˆ | 2 | 0 | 0% |
| Phase 8: å‰ç«¯ | 9 | 0 | 0% |
| **æ€»è®¡** | **47** | **0** | **0%** |

---

## é™„å½•

### A. æ–°å¢æ–‡ä»¶å®Œæ•´æ¸…å•

```
backend/
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”œâ”€â”€ recharge_record.go      â¬œ
â”‚   â”‚   â”œâ”€â”€ promotion.go            â¬œ
â”‚   â”‚   â”œâ”€â”€ referral.go             â¬œ
â”‚   â”‚   â””â”€â”€ payment_order.go        â¬œ
â”‚   â”‚
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ recharge_record_repo.go â¬œ
â”‚   â”‚   â”œâ”€â”€ promotion_repo.go       â¬œ
â”‚   â”‚   â”œâ”€â”€ promotion_cache.go      â¬œ
â”‚   â”‚   â”œâ”€â”€ referral_repo.go        â¬œ
â”‚   â”‚   â”œâ”€â”€ referral_cache.go       â¬œ
â”‚   â”‚   â”œâ”€â”€ payment_order_repo.go   â¬œ
â”‚   â”‚   â””â”€â”€ payment_cache.go        â¬œ
â”‚   â”‚
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ ports/
â”‚   â”‚   â”‚   â”œâ”€â”€ balance.go          â¬œ
â”‚   â”‚   â”‚   â”œâ”€â”€ promotion.go        â¬œ
â”‚   â”‚   â”‚   â”œâ”€â”€ referral.go         â¬œ
â”‚   â”‚   â”‚   â”œâ”€â”€ payment.go          â¬œ
â”‚   â”‚   â”‚   â”œâ”€â”€ zpay.go             â¬œ
â”‚   â”‚   â”‚   â””â”€â”€ stripe.go           â¬œ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ balance_service.go      â¬œ
â”‚   â”‚   â”œâ”€â”€ promotion_service.go    â¬œ
â”‚   â”‚   â”œâ”€â”€ referral_service.go     â¬œ
â”‚   â”‚   â”œâ”€â”€ payment_service.go      â¬œ
â”‚   â”‚   â”œâ”€â”€ zpay_service.go         â¬œ
â”‚   â”‚   â””â”€â”€ stripe_service.go       â¬œ
â”‚   â”‚
â”‚   â””â”€â”€ handler/
â”‚       â”œâ”€â”€ balance_handler.go      â¬œ
â”‚       â”œâ”€â”€ promotion_handler.go    â¬œ
â”‚       â”œâ”€â”€ referral_handler.go     â¬œ
â”‚       â”œâ”€â”€ payment_handler.go      â¬œ
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ payment_handler.go  â¬œ
â”‚
â””â”€â”€ migrations/
    â”œâ”€â”€ 005_recharge_record.sql     â¬œ
    â”œâ”€â”€ 006_promotion.sql           â¬œ
    â”œâ”€â”€ 007_referral.sql            â¬œ
    â””â”€â”€ 008_payment_order.sql       â¬œ

frontend/src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ payment.ts                  â¬œ
â”‚   â””â”€â”€ referral.ts                 â¬œ
â”‚
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ PaymentView.vue         â¬œ
â”‚   â”‚   â”œâ”€â”€ RechargeRecordsView.vue â¬œ
â”‚   â”‚   â””â”€â”€ ReferralView.vue        â¬œ
â”‚   â”‚
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ PaymentOrdersView.vue   â¬œ
â”‚
â””â”€â”€ components/
    â””â”€â”€ PromotionBanner.vue         â¬œ
```

### B. Go ä¾èµ–

```bash
# Stripe SDK
go get github.com/stripe/stripe-go/v76
```

### C. ç›¸å…³ç°æœ‰æ–‡ä»¶ï¼ˆéœ€ä¿®æ”¹ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `internal/config/config.go` | æ·»åŠ æ–°é…ç½®ç»“æ„ |
| `internal/service/auth_service.go` | é›†æˆæ´»åŠ¨å’Œé‚€è¯· |
| `internal/repository/wire.go` | æ·»åŠ  Provider |
| `internal/service/wire.go` | æ·»åŠ  Provider |
| `internal/handler/wire.go` | æ·»åŠ  Provider |
| `internal/server/router.go` | æ³¨å†Œæ–°è·¯ç”± |
| `config.yaml` | æ·»åŠ é…ç½®é¡¹ |
