# 支付系统迁移汇报

---

## 一、项目背景

### 1.1 迁移目标

将原 CRS 系统的支付、运营功能模块整合到当前 Sub2API 平台，提升用户付费转化和留存。

### 1.2 迁移范围

| 功能模块 | 说明 | 业务价值 |
|---------|------|---------|
| 💰 **在线支付** | 支持 Zpay + Stripe 双渠道 | 降低充值门槛，提升付费转化率 |
| 🎁 **新人活动** | 72小时限时充值返赠 | 刺激新用户首充，提升 ARPU |
| 👥 **邀请返利** | 老带新激励机制 | 零成本获客，裂变增长 |
| 💵 **余额流水** | 完整充值/扣款记录 | 财务审计，用户信任度 |

---

## 二、技术方案概述

### 2.1 技术栈适配

| 维度 | 原系统 | 当前系统 | 适配方案 |
|------|-------|---------|---------|
| 后端语言 | Node.js | **Go 1.24** | 重写，保留业务逻辑 |
| 数据库 | Redis 主存储 | **PostgreSQL** | 结构化存储，更可靠 |
| 架构 | 单文件服务 | **分层架构** | Handler→Service→Repository |

### 2.2 新增数据库表

| 表名 | 用途 | 数据量预估 |
|------|------|-----------|
| `payment_orders` | 支付订单 | 用户数 × 5/月 |
| `recharge_records` | 余额流水 | 用户数 × 10/月 |
| `user_promotions` | 活动状态 | = 用户数 |
| `referral_codes` | 邀请码 | = 用户数 |
| `referral_invites` | 邀请关系 | 用户数 × 0.5 |
| `promotion_records` | 活动记录 | 用户数 × 0.3 |

### 2.3 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户端 (Vue 3)                             │
├──────────────┬──────────────┬──────────────┬───────────────────────┤
│   充值页面   │   充值记录   │   邀请页面   │      活动横幅         │
└──────┬───────┴──────┬───────┴──────┬───────┴───────────┬───────────┘
       │              │              │                   │
       ▼              ▼              ▼                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          API Gateway (Gin)                          │
├─────────────────────────────────────────────────────────────────────┤
│  /payment/*     /users/recharge-records   /users/referral/*         │
└──────┬───────────────────────────┬──────────────────────────────────┘
       │                           │
       ▼                           ▼
┌─────────────────────┐     ┌─────────────────────┐
│   PaymentService    │     │   ReferralService   │
│   PromotionService  │     │   BalanceService    │
└──────────┬──────────┘     └──────────┬──────────┘
           │                           │
           ▼                           ▼
┌─────────────────────┐     ┌─────────────────────┐
│      PostgreSQL     │     │       Redis         │
│     (主数据存储)     │     │    (缓存/限流)      │
└─────────────────────┘     └─────────────────────┘
           │
    ┌──────┴──────┐
    ▼             ▼
┌────────┐   ┌────────┐
│  Zpay  │   │ Stripe │
│ (国内) │   │ (海外) │
└────────┘   └────────┘
```

---

## 三、业务流程设计

### 3.1 支付充值流程

```
用户发起充值 → 创建订单 → 跳转支付 → 支付回调 → 到账
     │              │           │          │        │
     │              ▼           │          ▼        ▼
     │        [检查活动]        │     [更新订单]  [记录流水]
     │              │           │          │        │
     │              ▼           │          ▼        ▼
     │        [计算返赠]        │     [充值余额]  [处理返利]
     │                          │                   │
     └──────────────────────────┼───────────────────┘
                                ▼
                         支付完成通知
```

### 3.2 新人活动规则

| 时间窗口 | 返赠比例 | 说明 |
|---------|---------|------|
| 注册后 24 小时 | **30%** | 首日最高奖励 |
| 注册后 36 小时 | 20% | |
| 注册后 48 小时 | 10% | |
| 注册后 72 小时 | 5% | 最后机会 |

**示例：** 用户在注册后 12 小时内充值 ¥100，按 7.2 汇率 = $13.89，返赠 30% = **$4.17**，实际到账 **$18.06**

### 3.3 邀请返利规则

```
邀请人 A ──────────► 生成邀请码 ──────────► 分享给朋友
                                              │
                                              ▼
被邀请人 B ◄───────── 使用邀请码注册 ◄─────────┘
     │
     │ 累计充值达 ¥20
     ▼
邀请人 A ◄───────── 获得 $10 返利 ◄───────── 系统自动发放
```

---

## 四、实施计划

### 4.1 阶段划分

| 阶段 | 主要工作 | 预估工作量 | 依赖关系 |
|------|---------|-----------|---------|
| **Phase 1** | 数据库设计与迁移 | 4 个表 + 索引 | - |
| **Phase 2** | 后端核心开发 | 6 个 Service + 7 个 Repository | Phase 1 |
| **Phase 3** | API 接口开发 | 5 个 Handler + 路由 | Phase 2 |
| **Phase 4** | 前端页面开发 | 4 个页面 + 组件 | Phase 3 |
| **Phase 5** | 联调测试上线 | 集成测试 + 灰度发布 | Phase 4 |

### 4.2 当前进度

```
规划设计:  ████████████████████ 100%  ✅ 已完成
数据库:    ░░░░░░░░░░░░░░░░░░░░   0%  ⏳ 待开始
后端开发:  ░░░░░░░░░░░░░░░░░░░░   0%  ⏳ 待开始
前端开发:  ░░░░░░░░░░░░░░░░░░░░   0%  ⏳ 待开始
测试上线:  ░░░░░░░░░░░░░░░░░░░░   0%  ⏳ 待开始
─────────────────────────────────────────────
总体进度:  █░░░░░░░░░░░░░░░░░░░   5%  (仅规划完成)
```

### 4.3 工作量预估

| 类别 | 新增文件数 | 说明 |
|------|-----------|------|
| Model | 4 | 数据模型 |
| Migration | 4 | 数据库迁移脚本 |
| Repository | 7 | 数据访问层 |
| Service | 12 | 业务逻辑层 (含接口) |
| Handler | 5 | API 处理器 |
| 前端页面 | 4 | Vue 3 页面 |
| 前端组件 | 2 | 可复用组件 |
| **合计** | **38** | |

---

## 五、预期收益

### 5.1 业务收益

| 指标 | 预期提升 | 说明 |
|------|---------|------|
| 付费转化率 | +15-25% | 降低充值门槛 |
| 新用户首充率 | +20-30% | 活动刺激 |
| 用户获取成本 | -30-50% | 邀请裂变 |
| 用户 ARPU | +10-15% | 活动返赠刺激充值 |

### 5.2 技术收益

- **支付多渠道**：Zpay (国内) + Stripe (海外)，覆盖全球用户
- **完整审计**：余额流水可追溯，满足财务合规
- **可扩展架构**：分层设计，易于后续扩展新功能

---

## 六、风险与应对

### 6.1 风险评估

| 风险 | 等级 | 影响 | 应对措施 |
|------|------|------|---------|
| 支付回调丢失 | 高 | 用户未到账 | 幂等设计 + 对账机制 |
| 活动被薅羊毛 | 中 | 资金损失 | 限制条件 + 风控规则 |
| 数据迁移问题 | 低 | 历史数据丢失 | 分步迁移 + 回滚方案 |

### 6.2 关键技术保障

```go
// 支付回调幂等处理示例
func HandleCallback(orderNo string) error {
    order := GetOrder(orderNo)
    if order.Status != "pending" {
        return nil  // 已处理，直接返回
    }
    // 事务处理，保证原子性
    return db.Transaction(func(tx) error {
        UpdateOrderStatus(tx, order, "paid")
        RechargeBalance(tx, order.UserID, order.Amount)
        RecordFlow(tx, order)
        return nil
    })
}
```

---

## 七、总结与建议

### 7.1 总结

本次迁移将 CRS 系统的支付运营模块整合到 Sub2API 平台，采用 Go + PostgreSQL 技术栈，实现：

1. **在线支付**：支持 Zpay + Stripe 双渠道
2. **新人活动**：72 小时限时返赠，最高 30%
3. **邀请返利**：老带新机制，达标返 $10
4. **余额流水**：完整的充值/扣款记录

### 7.2 建议

1. **分阶段上线**：先上支付+流水，再上活动+返利
2. **灰度发布**：小范围测试后全量
3. **监控告警**：支付成功率、回调延迟等核心指标

---

## 附录

### A. 相关文档

| 文档 | 说明 |
|------|------|
| `docs/PAYMENT_MIGRATION_CHECKLIST.md` | 详细技术规划文档 |
| `docs/crs/INTEGRATION_GUIDE.md` | 原系统集成指南 |

### B. 支付渠道对比

| 渠道 | 支持地区 | 支付方式 | 手续费 |
|------|---------|---------|-------|
| Zpay | 中国大陆 | 支付宝、微信 | ~1% |
| Stripe | 全球 | 信用卡、Apple Pay | ~3% |
